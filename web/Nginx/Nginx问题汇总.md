# Nginx问题汇总
---
---

## 1. 请解释一下什么是Nginx?
【答案】Nginx是一个web服务器和反向代理服务器，用于HTTP、HTTPS、SMTP、POP3和IMAP协议。
【解释】
- web服务器，即在服务端接收和响应也来自浏览器的http请求的
- 反向代理服务器：代理的意思是“我帮你”，正向代理即A要访问B的时候，由于A和B不互通，但是C可以访问B，因此C可以作为A的代理服务器，这里面清楚的知道要访问的资源是B，所以就叫正向代理；反向代理则是我有一个服务器集群，即我对外提供服务的时候，对外需要一个反向代理服务器，把访问资源的请求具体分发到某一台服务器上，这个过程我们并不知道是哪一台服务器来对我们服务。
- 其实主要是用于TCP连接相关的协议，但是Nginx也支持UDP的转发和负载均衡。


## 2. 请列举Nginx的一些特性
【答案】Nginx服务器的特性包括：
1. 反向代理
2. L7负载均衡器
3. 嵌入式Perl解释器
4. 动态二进制升级，即平滑升级
5. 动静分离
6. 可用于重新编写URL，具有非常好的PCRE支持

【解释】对于上述的特性，并不是Nginx独有
1. 现在最简单最好用的反向代理服务器还是Nginx
2. L7的负载均衡器，实际上，当不同业务需求，我们也可以使用L4的负载均衡配置。
	 - 所谓七层负载均衡，也称为“内容交换”，也就是主要通过报文中的真正有意义的应用层内容，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。
	 - 所谓四层负载均衡，也就是主要通过报文中的目标地址和端口，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。
3. 嵌入式Perl解释器，但是并没有Python解释器。如果对于一个绝大部分内容是静态的网站，只有极少数的地方需要动态显示，碰巧你又了解一点perl知识，那么nginx + perl的结合就能很好解决问题。
4. Nginx支持二进制文件直接替换然后完成升级，也可以在运行时候完成模块的添加操作。Nginx使用Unix信号机制来触发这一功能，更新命令为：
```linux
kill -USR2 `cat /usr/local/nginx/nginx.pid`

kill -QUIT `cat /usr/local/nginx/nginx.pid.oldbin`
```

在Nginx源码目录下，文件ngx_config.h中有以下代码：
```c++
#define NGX_CHANGEBIN_SIGNAL     USR2

#define NGX_SHUTDOWN_SIGNAL      QUIT
```
因为文件/usr/local/nginx/nginx.pid中保存的是当前Nginx进程pid，所以:
- 第一条命令旨在告诉Nginx二进制文件改变了，Nginx会将/usr/local/nginx/nginx.pid重命名为/usr/local/nginx/nginx.pid.oldbin。
- 第二条命令旨在通知Nginx老进程从容地退出。
 
 5. 动静分离，Nginx可以通过对不同的配置内容来区分动态资源和静态资源的访问路径
- 静态资源： 当用户多次访问这个资源，资源的源代码永远不会改变的资源。
- 动态资源：当用户多次访问这个资源，资源的源代码可能会发送改变。

为什么动静分离：
动静分离将网站静态资源（HTML，JavaScript，CSS，img等文件）与后台应用分开部署，提高用户访问静态代码的速度，降低对后台应用访问。这里我们将静态资源放到nginx中，动态资源转发到tomcat服务器中。

6. URL重写
URL重写是指将一个URL请求重新写成网站可以处理的另一个URL的过程。这样说可能不是很好理解，举个例子来说明一下，在开发中可能经常遇到这样的需求，比如通过浏览器请求的http://localhost:8080/getUser?id=1，但是需要通过SEO优化等等原因，需要把请求的地址重写为http://localhost:8080/getUser/1这样的URL，从而符合需求或者更好的被网站阅读。


## 3. 请列举Nginx和Apache 之间的不同点
- Nginx除了是web服务器，还是一个反向代理服务器
- Apache是一个开源的，成熟的web服务器

- Nginx
	- 轻量级，采用 C 进行编写，同样的 web 服务，会占用更少的内存及资源
    - 抗并发，nginx 以 epoll and kqueue 作为开发模型，处理请求是异步非阻塞的，负载能力比 apache 高很多，而 apache 则是阻塞型的。在高并发下 nginx 能保持低资源低消耗高性能 ，而 apache 在 PHP 处理慢或者前端压力很大的情况下，很容易出现进程数飙升，从而拒绝服务的现象。
    - 服务器并发指的是多个用户同时访问数据库中的同一字段的行为。这样的用户行为对于服务器的性能是一种考验。我们经常能遇到由于并发用户过多而导致的系统缓慢甚至瘫痪现象。比方说，很多使用过那些在线考试报名系统的朋友都会发现，半夜登录系统报名比白天登录系统报名要容，网页反应速度也要快一些，这就是由于晚上的并发用户数比较小的原因。
    - nginx 处理静态文件好，静态处理性能比 apache 高三倍以上
    - nginx 的设计高度模块化，编写模块相对简单
    - nginx 配置简洁，正则配置让很多事情变得简单，而且改完配置能使用 -t 测试配置有没有问题，apache 配置复杂 ，重启的时候发现配置出错了，会很崩溃
    - nginx 作为负载均衡服务器，支持 7 层负载均衡
    - 负载均衡分为四层和七层，四层模式下这些SYN攻击都会被转发到后端的服务器上；而七层模式下这些SYN攻击自然在负载均衡设备上就截止，不会影响后台服务器的正常运营。
    - nginx 本身就是一个反向代理服务器，而且可以作为非常优秀的邮件代理服务器
    - 反向代理是代理服务器的一种。服务器根据客户端的请求，从其关系的一组或多组后端服务器（如Web服务器）上获取资源，然后再将这些资源返回给客户端，客户端只会得知反向代理的IP地址，而不知道在代理服务器后面的服务器簇的存在。
    - 启动特别容易, 并且几乎可以做到 7*24 不间断运行，即使运行数个月也不需要重新启动，还能够不间断服务的情况下进行软件版本的升级
    - 社区活跃，各种高性能模块出品迅速

- Apache
   - apache 的 rewrite 比 nginx 强大，在 rewrite 频繁的情况下，用 apache
   - apache 发展到现在，模块超多，基本想到的都可以找到
   - apache 更为成熟，少 bug ，nginx 的 bug 相对较多
   - apache 超稳定
   - apache 对 PHP 支持比较简单，nginx 需要配合其他后端用
   - apache 在处理动态请求有优势，nginx 在这方面是鸡肋，一般动态请求要 apache 去做，nginx 适合静态和反向。
   - apache 仍然是目前的主流，拥有丰富的特性，成熟的技术和开发社区

两者的根本区别就是：
- Nginx使用的是一个进程处理多个连接、非阻塞IO模式，Nginx用的是epoll。也就是一个进程维护着多个连接，worker来接收连接。
- Apache是基于一个线程处理一个请求的非阻塞IO并发策略，即Apache主要用的是select。一个线程开一个连接，一个进程维护多个线程。
意味着Nginx在处理高并发的优势是高于Apache的


## 4. 请解释Nginx如何处理HTTP请求。

Nginx使用反应器模式。主事件循环等待操作系统发出准备事件的信号，这样数据就可以从套接字读取，在该实例中读取到缓冲区并进行处理。单个线程可以提供数万个并发连接。

nginx会根据过来的http请求头里的Host字段里的值，来判断使用哪个server{}。

    如果请求头里没有Host字段，或者Host字段里的值，和Nginx配置文件里的server{}里的{server_name}都不匹配，则使用第一个server{}，来处理这个请求。
    如果请求头里的Host字段里的值和Nginx配置文件里的某个server{}里的{server_name}，匹配上了，则使用这个server{}，来处理这个请求。

可以使用curl工具来方便的做实验，curl可以设置http请求的请求头，所以可以任意设置Host字段，用【-H】来设置。下面的10.210.65.73是安装了nginx的机器的IP地址。

所以用下面的命令，发送了http请求后，nginx就会使用server{server_name aaa}来处理这个请求。
```linux
curl.exe -H "Host: aaa" 10.210.65.73
```
非常重要的结论：server_name对应的是http请求头里的Host字段的值

## 5. 在Nginx中，如何使用未定义的服务器名称来阻止处理请求?

只需将请求删除的服务器就可以定义为：

Server {

listen 80;

server_name “ “ ;

return 444;

}

这里，服务器名被保留为一个空字符串，它将在没有“主机”头字段的情况下匹配请求，而一个特殊的Nginx的非标准代码444被返回，从而终止连接。

## 6. 使用“反向代理服务器”的优点是什么?

反向代理服务器可以隐藏源服务器的存在和特征。它充当互联网云和web服务器之间的中间层。这对于安全方面来说是很好的，特别是当您使用web托管服务时。

## 7. 请列举Nginx服务器的最佳用途。

Nginx服务器的最佳用法是在网络上部署动态HTTP内容，使用SCGI、WSGI应用程序服务器、用于脚本的FastCGI处理程序。它还可以作为负载均衡器。

## 8. 请解释Nginx服务器上的Master和Worker进程分别是什么?

Master进程：读取及评估配置和维持

Worker进程：处理请求

Master进程：master进程负责管理worker进程，并负责读取配置文件和判断文件语法的工作；是主进程，且只有一个。
Worker进程：worker进程有多个，它负责处理请求；worker的进程数量由管理员自己定义；
worker_processes 1;意思是nginx启动后，worker进程只有一个，如果想有多个，可以自己改动，但不能超过机器CPU的核心数量

## 9. 请解释你如何通过不同于80的端口开启Nginx?

为了通过一个不同的端口开启Nginx，你必须进入/etc/Nginx/sites-enabled/，如果这是默认文件，那么你必须打开名为“default”的文件。编辑文件，并放置在你想要的端口：

Like server { listen 81; }

## 10. 请解释是否有可能将Nginx的错误替换为502错误、503?

502 =错误网关

503 =服务器超载

有可能，但是您可以确保fastcgi_intercept_errors被设置为ON，并使用错误页面指令。
```nginxconf
location / {

fastcgi_pass 127.0.01:9001;

fastcgi_intercept_errors on;

error_page 502 =503/error_page.html;

#…
```
这个指令指定是否传递4xx和5xx错误信息到客户端，或者允许nginx使用error_page处理错误信息。
你必须明确的在error_page中指定处理方法使这个参数有效，正如Igor所说“如果没有适当的处理方法，nginx不会拦截一个错误，这个错误不会显示自己的默认页面，这里允许通过某些方法拦截错误

## 11. 在Nginx中，解释如何在URL中保留双斜线?

要在URL中保留双斜线，就必须使用merge_slashes_off;

语法:merge_slashes [on/off]

默认值: merge_slashes on

环境: http，server

## 12. 请解释ngx_http_upstream_module的作用是什么?

ngx_http_upstream_module用于定义可通过fastcgi传递、proxy传递、uwsgi传递、memcached传递和scgi传递指令来引用的服务器组。

upstream name
用于将多个服务器定义成服务器组，而由proxy_pass, fastcgi_pass等指令进行引用

## 13. 请解释什么是C10K问题?

C10K问题是指无法同时处理大量客户端(10,000)的网络套接字。

## 14. 请陈述stub_status和sub_filter指令的作用是什么?

Stub_status指令：该指令用于了解Nginx当前状态的当前状态，如当前的活动连接，接受和处理当前读/写/等待连接的总数

Sub_filter指令：它用于搜索和替换响应中的内容，并快速修复陈旧的数据

## 15. 解释Nginx是否支持将请求压缩到上游?

您可以使用Nginx模块gunzip将请求压缩到上游。gunzip模块是一个过滤器，它可以对不支持“gzip”编码方法的客户机或服务器使用“内容编码:gzip”来解压缩响应。

## 16. 解释如何在Nginx中获得当前的时间?

要获得Nginx的当前时间，必须使用SSI模块、$date_gmt和$date_local的变量。

Proxy_set_header THE-TIME $date_gmt;

## 17. 用Nginx服务器解释-s的目的是什么?

用于运行Nginx -s参数的可执行文件。

## 18. 解释如何在Nginx服务器上添加模块?


在编译过程中，必须选择Nginx模块，因为Nginx不支持模块的运行时间选择。

## 19. 负载均衡的几种常用方式？几种策略

1、轮询（默认）

2、weight（权重） ，即指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的

情况。

upstream backserver {

server 192.168.0.14 weight=3;

server 192.168.0.15 weight=7;

}

权重越高，在被访问的概率越大，如上例，分别是30%，70%。

但是上述方式存在一个问题就是说，在负载均衡系统中，假如用户在某台服务器上登录了，那么该用户第二次请求的时候，因为我们是负载均衡系统，每次请求都会重新定位到服务器集群中的某一个，那么已经登录某一个服务器的用户再重新定位到另一个服务器，其登录信息将会丢失，这样显然是不妥的。

3、ip_hash：   每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。

4、url_hash：

5、fair（第三方） ：按后端服务器的响应时间来分配请求，响应时间短的优先分配。

## 20. 即session不同步怎么办?（因为Nginx默认的轮询方法是有这个问题的）

我们可以采用ip_hash指令解决这个问题，如果客户已经访问了某个服务器，当用户再次访问时，会将该请求通过哈希算法，自动定位到该服务器。即每个访客固定访问一个后端服务器，可以解决session的问题。

其他办法：那就是用spring_session+redis，把session放到缓存中实现session共享